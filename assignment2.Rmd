---
title: "MUSA 508, Assignment 2 - Spatial Machine Learning"
author: "Austin, Lan"
output: html_document
---

```{r setup, include=FALSE}
# You can set some global options for knitting chunks
knitr::opts_chunk$set(echo = TRUE)
```

**please choose and run this this chunk first everytime**
```{r set working directory}
# for Lan
setwd("/Users/lexi/Desktop/UPENN_COURSE/MUSA_508/assignment/assignment2")

# for Austin
#setwd("C:/Users/austi/Desktop/Penn/Classes/PublicPolicy/Assignments/Midterm")
```

```{r setup}
# Load some libraries
library(tidyverse)
library(sf)
#library(spdep)
#library(caret)
#library(ckanr)
#library(FNN)
#library(grid)
#library(gridExtra)
#library(ggcorrplot)
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(mapview)

# functions and data directory
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# color set up
# yellow to green
palette1 <- c('#f2d6a2', '#dfd688', '#ccd270', '#b8ca58', '#a4bf41')  # lighter one
palette2 <- c('#ffd358', '#e1cf5b', '#b9bc4e', '#879a32', '#4f6d00')   # stronger one
palette3 <- c('#f2d6a2', '#e9d596', '#dfd38a', '#d6d17e', '#ccce72', '#c2cb66', '#b8c85a', '#aec44d', '#a4bf41')  # lighter one with more gradient
```


# Data Wrangling

## Data Loading and Cleaning

**loading data and transforming in to 'ESRI:102254'**

**(glimpsing with mapview / simply plot)**

**removing error data and trimming data into county limits**
two ways to trim, select from "county" column, or use geometry

**(selecting a specific subset)**
sometimes need sometimes not, decisions will be made depending on group summary

load property-information data
```{r load physical characteristic data}
physical_data <- st_read("data/studentData.geojson") %>% 
  st_set_crs('ESRI:102254')
```
load Boulder city boundary
```{r load city boundary data}
city_boundary <- st_read("https://opendata.arcgis.com/datasets/955e7a0f52474b60a9866950daf10acb_0.geojson") %>% 
  st_transform('ESRI:102254') %>% 
  st_union() %>% 
  st_buffer(1) %>%
  st_sf()
```
load Boulder county boundary
```{r load county boundary data}
county_boundary <- st_read("https://opendata.arcgis.com/datasets/964b8f3b3dbe401bb28d49ac93d29dc4_0.geojson") %>% 
  st_transform('ESRI:102254') 
```
### School
load and clean school attendance area data
```{r load school attendance area data}
# load elementaryry attendance are data 
# BVSD school district 
area.BVSD.elementary <- st_read("data/BVSD_elmtr_area.geojson") %>% 
  st_transform('ESRI:102254') %>% 
    dplyr::select(SchName, State_CD)
area.BVSD.elementary$SchName <- toupper(area.BVSD.elementary$SchName)
# merge area have 2 school options
# only FID 1
area.FID1 <- st_union(
    area.BVSD.elementary %>% 
    filter(SchName  == "CREEKSIDE"),
  area.BVSD.elementary %>% 
    filter(SchName == "BC-CREEKSIDE  ELEMENTARY SCHOOL")
) %>% 
    dplyr::select(SchName, State_CD)
area.FID2 <- st_union(
    area.BVSD.elementary %>% 
    filter(SchName  == "MESA"),
  area.BVSD.elementary %>% 
    filter(SchName == "BC-MESA ELEMENTARY SCHOOL")
) %>% 
    dplyr::select(SchName, State_CD)
# rbind back
area.BVSD.elementary <- rbind(
  area.FID1,
  area.FID2,
  area.BVSD.elementary %>% 
    dplyr::filter(State_CD != "0") %>% 
    dplyr::filter(SchName != "MESA" & SchName != "CREEKSIDE") %>% 
    dplyr::select(SchName, State_CD)
) 
# St Vrain Valley School District 
area.SVV.elementary <- st_read("data/SVV_elmtr_area.geojson") %>% 
  st_transform('ESRI:102254') %>% 
    dplyr::select(SchName)
area.SVV.elementary$SchName <- toupper(area.SVV.elementary$SchName)
# Estate Park & Thompson
area.other.elementary <- st_read("data/SABS_1516_SchoolLevels/SABS_1516_Primary.shp") %>% 
  st_transform('ESRI:102254') %>% 
  filter(leaid == "0803810" | leaid == "0805400")%>%
  dplyr::select(schnam)
area.other.elementary <- area.other.elementary[county_boundary,]
area.other.elementary$schnam <- toupper(area.other.elementary$schnam)

# load high school attendance are data 
# BVSD District 
area.BVSD.high <- st_read("data/BVSD_hsc_area.geojson") %>% 
  st_transform('ESRI:102254') %>% 
  dplyr::select(SchName, State_CD, FID)
area.BVSD.high$SchName <- toupper(area.BVSD.high$SchName)
# merge area have 2 school options
# only FID 1
area.FID1 <- st_union(
  area.BVSD.high %>% 
    filter(FID == "1"),
  area.BVSD.high %>% 
    filter(FID == "2")
) %>% 
  dplyr::select(SchName, State_CD)
# rbind FID 1 back
area.BVSD.high <- rbind(
  area.FID1,
  area.BVSD.high %>% 
    dplyr::filter(FID != "2" & FID != "1") %>% 
    dplyr::select(SchName, State_CD)
) 
# St Vrain Valley School District 
area.SVV.high <- st_read("data/SVV_hsc_area.geojson") %>% 
  st_transform('ESRI:102254') %>% 
    dplyr::select(SchName)
area.SVV.high$SchName <- toupper(area.SVV.high$SchName)
# Estate Park & Thompson
area.other.high <- st_read("data/SABS_1516_SchoolLevels/SABS_1516_High.shp") %>% 
  st_transform('ESRI:102254') %>% 
  filter(leaid == "0803810" | leaid == "0805400")%>%
  dplyr::select(schnam)
area.other.high <- area.other.high[county_boundary,]
area.other.high$schnam <- toupper(area.other.high$schnam)
```

load school data 
```{r load school data, message=FALSE}
# load school data
schools <- st_read("data/Public_Schools.geojson") %>% 
  st_transform('ESRI:102254')
```
trim schools to those within Boulder county and select schools are operational and regular
```{r schools trim within Boulder}
# trim within Boulder
schools <- rbind(
  schools %>% 
    dplyr::filter(NAME == "BROOMFIELD HIGH SCHOOL"), # This school isn't within Boulder, but some Boulder residents should attend it
  schools %>% 
    # select regular schools
    dplyr::filter(TYPE == "1") %>% 
    # select operational schools
    dplyr::filter(STATUS == "1") %>% 
    dplyr::filter(NAME != "NEW VISTA HIGH SCHOOL")  # This school isn't in school district list
)
schools <- schools[st_buffer(county_boundary,10000),]
```

load school rating data
```{r load school rating data}
# load and filter by district
school.ratings <- read_csv("data/SPF_Final Ratings_2010-201.csv")

# transfername to capital
school.ratings$Name <- toupper(x=school.ratings$Name)
```
### Hospital
load hospital data
```{r load hospital data, message=FALSE}
# load and select field
hospitals <- st_read("data/hOSPITALS.geojson") %>% 
  st_transform('ESRI:102254')
```
trim hospitals to those within Boulder county and select hospitals are general and open
```{r hospitals trim within Boulder}
# trim within Boulder
hospitals <- hospitals[county_boundary,] %>% 
  dplyr::filter(COUNTY == 'BOULDER') %>% 
  #select open hospitals
  dplyr::filter(STATUS == "OPEN") %>% 
  # select GENERAL MEDICAL AND SURGICAL HOSPITALS
  dplyr::filter(NAICS_DESC == "GENERAL MEDICAL AND SURGICAL HOSPITALS") %>% 
  # select variables
  dplyr::select(NAME, CITY, TRAUMA)
```
combine school area with school rating data
```{r combine school area with school rating data}
# join BVSD high
school.high <- right_join(
  school.ratings,
  area.BVSD.high,
  by = c("SchoolNumber" = "State_CD")
) %>% 
  dplyr::select(DistrictName, Name, Total_Percent_Points, geometry)
# join SVV high
school.high <- rbind(
  right_join(
  school.ratings,
  area.SVV.high,
  by = c("Name" = "SchName"))%>% 
    dplyr::select(DistrictName, Name, Total_Percent_Points, geometry),
  school.high
)
# join Estate Park & Thompson high
school.high <- rbind(
  right_join(
  school.ratings,
  area.other.high,
  by = c("Name" = "schnam"))%>% 
    dplyr::select(DistrictName, Name, Total_Percent_Points, geometry),
  school.high
)
# trim within Boulder
school.high <- st_sf(school.high)
school.high <- st_intersection(school.high, county_boundary) %>% 
  dplyr::select(DistrictName, Name, Total_Percent_Points, geometry)

# join BVSD elementary
school.elementary <- right_join(
  school.ratings,
  area.BVSD.elementary,
  by = c("SchoolNumber" = "State_CD")
)%>% 
    dplyr::select(DistrictName, Name, Total_Percent_Points, geometry)
# join SVV elementary
school.elementary <- rbind(
  right_join(
  school.ratings,
  area.SVV.elementary,
  by = c("Name" = "SchName"))%>% 
    filter(DistrictName == "St Vrain Valley RE1J") %>% 
    dplyr::select(DistrictName, Name, Total_Percent_Points, geometry),
  school.elementary
)
# join Estate Park & Thompson elementary
school.elementary <- rbind(
  right_join(
  school.ratings,
  area.other.elementary,
  by = c("Name" = "schnam"))%>%
    dplyr::select(DistrictName, Name, Total_Percent_Points, geometry),
  school.elementary
)
# trim within Boulder
school.elementary <- st_sf(school.elementary)
school.elementary <- st_intersection(school.elementary, county_boundary)%>% 
  dplyr::select(DistrictName, Name, Total_Percent_Points, geometry)

```
combine school point with school rating data
```{r combine school point with school rating data}
# high school
school.high.point <- school.high %>% 
  st_drop_geometry() %>% 
  left_join(
    schools,
    by = c("Name" = "NAME")
  ) %>% 
  st_sf() %>% 
  filter(COUNTYFIPS %in% c("08013", "08014", "08069", "08123") |  is.na(COUNTYFIPS)) %>% 
  dplyr::select(DistrictName, Name) %>% 
  distinct()

# elementary school
school.elementary.point <- school.elementary %>% 
  st_drop_geometry() %>% 
  left_join(
    schools,
    by = c("Name" = "NAME")
  ) %>% 
  st_sf() %>% 
  filter(COUNTYFIPS %in% c("08013", "08014", "08059", "08069", "08123") |  is.na(COUNTYFIPS)) %>% 
  # remove those school with the same name
  filter(OBJECTID != "77522" | is.na(OBJECTID)) %>% 
  filter(OBJECTID != "60157" | is.na(OBJECTID)) %>%
  filter(DistrictName != "St Vrain Valley RE1J" | CITY != "BOULDER" | is.na(CITY)) %>% 
  filter(DistrictName != "Boulder Valley Re 2" | CITY != "LONGMONT" | is.na(CITY)) %>% 
  dplyr::select(DistrictName,Name) %>% 
  distinct()

```

## Feature Engineering

**sum within census track** 
(least optional for most situation)

**sum within fixed buffer**
(assuming scale relationship uniform countywide)

**average distance of k-nearest case**
combine school name with sale data

### School
```{r}
# combine with high school
sale <- physical_data %>% 
  st_join(school.high)
# rename column
sale <- rename(sale, c( "high_school" = "Name","high_school_points" = "Total_Percent_Points"))

# combine with elementary school
sale <- sale %>% 
  st_join(school.elementary)
# rename column
sale <- rename(sale, c( "elmtr_school" = "Name","elmtr_school_points" = "Total_Percent_Points"))
```

combine school distance with sale data
```{r combine school distance with sale data}
# add distance to high school
# make a df contain school geometry with order
school.high.order <- sale %>% 
  st_drop_geometry() %>% 
  left_join(
    school.high.point,
    by = c("high_school" = "Name")
    ) %>% 
  st_sf() %>% 
  dplyr::select(MUSA_ID)
# calculate distance
sale <- sale %>% 
  dplyr::mutate(
    hsch_distance = st_distance(sale, school.high.order, by_element = TRUE)
  )

# add distance to elementary school
# make a df contain school geometry with order
school.elementary.order <- sale %>% 
  st_drop_geometry() %>% 
  left_join(
    school.elementary.point,
    by = c("elmtr_school" = "Name", "DistrictName.y" = "DistrictName")
    ) %>% 
  st_sf() %>% 
  dplyr::select(MUSA_ID)
# calculate distance
sale <- sale %>% 
  dplyr::mutate(
    elmtr_distance = st_distance(sale, school.elementary.order, by_element = TRUE)
  )
#ALICIA SANCHEZ ELEMENTARY SCHOOL
#x <- left_join(school.tidy, school.name, by= c("NAME" = "ICSCHNAME"), keep = TRUE)
```


## Exploratory Analysis

**log**

# Regression

# Cross-Validation










